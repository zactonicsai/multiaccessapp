databaseChangeLog:
  - changeSet:
      id: 005-create-audit-log-table
      author: enterprise-datasharing
      comment: Create audit log table for security and compliance tracking
      changes:
        - createTable:
            tableName: audit_log
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: username
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: user_roles
                  type: VARCHAR(500)
              - column:
                  name: user_department
                  type: VARCHAR(100)
              - column:
                  name: user_team
                  type: VARCHAR(100)
              - column:
                  name: action
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
              - column:
                  name: entity_type
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: entity_id
                  type: VARCHAR(255)
              - column:
                  name: field_name
                  type: VARCHAR(255)
              - column:
                  name: old_value
                  type: TEXT
              - column:
                  name: new_value
                  type: TEXT
              - column:
                  name: timestamp
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: ip_address
                  type: VARCHAR(45)
              - column:
                  name: user_agent
                  type: TEXT
              - column:
                  name: request_uri
                  type: VARCHAR(1000)
              - column:
                  name: http_method
                  type: VARCHAR(10)
              - column:
                  name: access_decision
                  type: VARCHAR(50)
              - column:
                  name: access_reason
                  type: TEXT
              - column:
                  name: required_role
                  type: VARCHAR(100)
              - column:
                  name: attribute_conditions
                  type: TEXT
              - column:
                  name: context_conditions
                  type: TEXT
              - column:
                  name: correlation_id
                  type: VARCHAR(100)
              - column:
                  name: session_id
                  type: VARCHAR(255)
              - column:
                  name: success
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: error_message
                  type: TEXT
              - column:
                  name: data_hash
                  type: VARCHAR(64)

  - changeSet:
      id: 005-create-audit-log-indexes
      author: enterprise-datasharing
      comment: Create indexes for audit_log table
      changes:
        - createIndex:
            indexName: idx_audit_timestamp
            tableName: audit_log
            columns:
              - column:
                  name: timestamp
        - createIndex:
            indexName: idx_audit_user
            tableName: audit_log
            columns:
              - column:
                  name: user_id
        - createIndex:
            indexName: idx_audit_action
            tableName: audit_log
            columns:
              - column:
                  name: action
        - createIndex:
            indexName: idx_audit_entity
            tableName: audit_log
            columns:
              - column:
                  name: entity_type
              - column:
                  name: entity_id
        - createIndex:
            indexName: idx_audit_access_decision
            tableName: audit_log
            columns:
              - column:
                  name: access_decision
        - createIndex:
            indexName: idx_audit_correlation
            tableName: audit_log
            columns:
              - column:
                  name: correlation_id
        - createIndex:
            indexName: idx_audit_ip
            tableName: audit_log
            columns:
              - column:
                  name: ip_address
